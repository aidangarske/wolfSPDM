name: Static Analysis

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  cppcheck:
    name: cppcheck
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Cache wolfSSL headers
      id: cache-wolfssl
      uses: actions/cache@v4
      with:
        path: ~/wolfssl-install
        key: wolfssl-ubuntu-latest-v1

    - name: Build wolfSSL
      if: steps.cache-wolfssl.outputs.cache-hit != 'true'
      run: |
        sudo apt-get install -y autoconf automake libtool
        cd ~
        git clone --depth 1 https://github.com/wolfSSL/wolfssl.git
        cd wolfssl
        ./autogen.sh
        ./configure --enable-ecc --enable-sha384 --enable-aesgcm --enable-hkdf \
                    --enable-ecccustcurves --enable-keygen \
                    --prefix=$HOME/wolfssl-install
        make -j$(nproc)
        make install

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance,portability \
                 --error-exitcode=1 \
                 --suppress=missingIncludeSystem \
                 --inline-suppr \
                 -I wolfspdm -I src -I $HOME/wolfssl-install/include \
                 src/ test/

  clang-analyzer:
    name: Clang Static Analyzer
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tools autoconf automake libtool

    - name: Cache wolfSSL
      id: cache-wolfssl
      uses: actions/cache@v4
      with:
        path: ~/wolfssl-install
        key: wolfssl-ubuntu-latest-v1

    - name: Build wolfSSL
      if: steps.cache-wolfssl.outputs.cache-hit != 'true'
      run: |
        cd ~
        git clone --depth 1 https://github.com/wolfSSL/wolfssl.git
        cd wolfssl
        ./autogen.sh
        ./configure --enable-ecc --enable-sha384 --enable-aesgcm --enable-hkdf \
                    --enable-ecccustcurves --enable-keygen \
                    --prefix=$HOME/wolfssl-install
        make -j$(nproc)
        make install

    - name: Configure
      run: |
        ./autogen.sh
        ./configure --with-wolfssl=$HOME/wolfssl-install --enable-nuvoton

    - name: Run scan-build
      run: scan-build --status-bugs -o scan-results make -j$(nproc)

    - name: Upload scan-build results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: scan-build-results
        path: scan-results/
